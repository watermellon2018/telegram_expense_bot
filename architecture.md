# Архитектура Telegram-бота для анализа расходов

## Общая структура проекта

```
telegram_expense_bot/
├── main.py                 # Основной файл запуска бота
├── config.py               # Конфигурационные параметры
├── requirements.txt        # Зависимости проекта
├── data/                   # Директория для хранения данных
│   └── users/              # Данные пользователей
│       └── {user_id}/      # Папки для каждого пользователя
│           └── {year}.xlsx # Excel-файлы по годам
├── handlers/               # Обработчики команд
│   ├── __init__.py
│   ├── start.py            # Обработчик команды /start
│   ├── expense.py          # Обработчик добавления расходов
│   └── stats.py            # Обработчики статистики и графиков
├── utils/                  # Вспомогательные функции
│   ├── __init__.py
│   ├── excel.py            # Функции для работы с Excel
│   ├── visualization.py    # Функции для создания графиков
│   └── helpers.py          # Общие вспомогательные функции
└── tests/                  # Тесты
    └── test_bot.py         # Тесты функциональности
```

## Структура данных

### Формат Excel-файла

Excel-файл для каждого года будет иметь следующую структуру:

1. **Лист "Expenses"** - основной лист с записями о расходах:
   - `date` (Дата) - дата расхода в формате YYYY-MM-DD
   - `time` (Время) - время добавления расхода в формате HH:MM:SS
   - `amount` (Сумма) - сумма расхода
   - `category` (Категория) - категория расхода
   - `description` (Описание) - опциональное описание расхода
   - `month` (Месяц) - числовое значение месяца (1-12) для удобства фильтрации

2. **Лист "Categories"** - список доступных категорий:
   - `category_name` (Название категории)
   - `emoji` (Эмодзи) - иконка для визуального представления категории

3. **Лист "Budget"** - информация о бюджете по месяцам:
   - `month` (Месяц) - числовое значение месяца (1-12)
   - `budget` (Бюджет) - установленный бюджет на месяц
   - `actual` (Фактические расходы) - автоматически обновляемое поле

### Идентификация пользователей

- Каждый пользователь идентифицируется по уникальному Telegram ID
- Для каждого пользователя создается отдельная папка в директории `data/users/`
- В папке пользователя хранятся Excel-файлы по годам и другие пользовательские данные

## Обработка команд

### Основные команды и их обработка

1. **Команда `/start`**
   - Приветствие нового пользователя
   - Создание структуры папок для пользователя
   - Отправка инструкций по использованию

2. **Добавление расхода**
   - Формат: `/add <сумма> <категория> [описание]`
   - Альтернативный формат: простое сообщение с суммой и категорией
   - Валидация введенных данных
   - Запись в соответствующий Excel-файл

3. **Получение статистики**
   - Команда `/month` - статистика за текущий месяц
   - Команда `/category <название>` - статистика по категории
   - Команда `/stats` - общая статистика

4. **Визуализация**
   - Команда `/graph` - построение графиков
   - Генерация изображений с графиками
   - Отправка изображений пользователю

5. **Управление бюджетом**
   - Команда `/budget <сумма>` - установка бюджета на месяц
   - Уведомления о приближении к лимиту бюджета

## Алгоритмы и процессы

### Процесс добавления расхода

1. Пользователь отправляет команду с суммой и категорией
2. Бот валидирует введенные данные
3. Определяет текущий год и соответствующий Excel-файл
4. Если файл не существует, создает новый с нужной структурой
5. Добавляет запись в лист "Expenses"
6. Обновляет фактические расходы в листе "Budget"
7. Отправляет подтверждение пользователю

### Процесс генерации статистики

1. Пользователь запрашивает статистику
2. Бот определяет нужный Excel-файл и загружает данные
3. Фильтрует данные по запрошенному периоду или категории
4. Выполняет необходимые расчеты (суммы, средние значения и т.д.)
5. Формирует текстовый отчет и/или визуализацию
6. Отправляет результат пользователю

### Процесс создания визуализаций

1. Загрузка данных из Excel-файла
2. Агрегация данных для визуализации
3. Создание графика с помощью matplotlib/seaborn
4. Сохранение графика как изображения
5. Отправка изображения пользователю

## Обработка ошибок и исключений

1. Валидация всех пользовательских вводов
2. Обработка некорректных команд с подсказками
3. Логирование ошибок для отладки
4. Восстановление после сбоев с минимальной потерей данных

## Расширяемость

1. Модульная структура для легкого добавления новых команд
2. Возможность добавления новых типов визуализаций
3. Поддержка пользовательских категорий расходов
4. Возможность интеграции с другими сервисами в будущем
